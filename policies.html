<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retreat Policies</title>
  <link rel="stylesheet" href="policies.css">
  <style>
    /* Basic modal styling for demonstration */
    #registerModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #registerModal .modal-content {
      background: #fff;
      padding: 2em;
      border-radius: 8px;
      text-align: center;
      min-width: 300px;
    }
    #registerModal button {
      margin: 1em;
      padding: 0.5em 2em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <form 
      id="policyForm"
      action="https://script.google.com/macros/s/AKfycbzhRzgHnATpwgKkkdsQPw2Pn4DRHO0Snh1B4K0NTRo0GXM8_KC0eHt0wNqtQSk9iVMY/exec"
      method="POST"
    >
      <h2>Retreat Policies</h2>
      <p>
        Please read through our policies and acknowledge them by signing your name and clicking submit
      </p>

      <h3>Permission to secure treatment</h3>
      <p>
        In the event of an emergency, I authorize New Life Christian Camp Association to secure from any licensed hospital, physician, and/or medical personnel any treatment deemed necessary for me or my minor child/ward's immediate care and agree that I will be responsible for payment of any and all medical services rendered. I understand that this authorization includes transporting my child by ambulance if necessary to the nearest medical treatment facility or hospital if I am unable to be reached first.
      </p>

      <h3>Release of liability and permission to secure treatment</h3>
      <p>
        I recognize and acknowledge that there are certain risks of physical injury to participants in the above program(s) and I agree to assume the full risk of any injuries, damages, or loss regardless of severity which I or my minor child/ward may sustain as a result of participating in any and all activities connected with or associated with such program(s). I agree to waive and relinquish all claims I or my minor child/ward may have against New Life Christian Camp Association, its officers, agents, volunteers, and employees as a result of participation in the program. I do hereby fully release and discharge New Life Christian Camp Association, its officers, agents, volunteers, and employees from any and all claims from injury, damage, or loss with the activities of the program(s). I further agree to indemnify and hold harmless and defend New Life Christian Camp Association and its officers, agents, volunteers, and employees from any and all claims resulting from injuries, damages, or losses sustained by me or my minor child/ward arising out of, connected with, or in any way associated with the activities of the program(s).
      </p>

      <h3>No responsibility disclaimer</h3>
      <p>
        I recognize and acknowledge that New Life Christian Camp Association shall not be held liable for any loss, theft, or damage to personal property, including but not limited to items brought onto the premises or in connection with any event or activity. Participants, guests, or attendees assume full responsibility for the security and safety of their belongings. By entering the premises or participating in the event, all individuals agree to release the organization from any and all claims, demands, and causes of action related to such loss, theft, or damage.
      </p>

      <h3>Photography and Videography Release</h3>
      <p>
        I grant permission to New Life Christian Camp Association to take photographs and videos of me and/or my minor child/ward during the retreat for promotional purposes. I understand that these images may be used in various media, including but not limited to brochures, websites, and social media. If I do not wish for my image or that of my child/ward to be used, I will notify the organization in writing prior to the event.
      </p>

      <p>
        By signing below, I fully acknowledge and understand all of NLCCA's policies and agree to abide by them.
      </p>
      <div>
        <label>
          <input type="checkbox" name="agreePolicy" required> I agree to the policies
        </label>
      </div>
      <div>
        <label for="dateCompleted">Date Completed:</label>
        <input type="date" id="dateCompleted" name="dateCompleted" required>
      </div>
      <div>
        <label for="signature">Electronic Signature:</label>
        <input type="text" id="signature" name="signature" required>
      </div>
      <div>
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>

  <!-- Modal for additional registration -->
  <div id="registerModal">
    <div class="modal-content">
      <p>Would you like to register another person?</p>
      <button id="yesBtn">Yes</button>
      <button id="noBtn">No</button>
    </div>
  </div>

  <script>
    // Array of field names you want to collect for each registrant
    const keys = [
      'firstName', 'lastName', 'dob', 'email', 'phone',
      'address', 'parentName', 'emergencyContactName', 'emergencyContactPhone',
      'allergies', 'allergyDetails', 'accommodations',
      'stayingPlace', 'stayingWith', 'bedsNeeded', 'roommates',
      'vbs', 'vbsDetails', 'otherNotes'
    ];

    // Get the form element
    const form = document.getElementById('policyForm');

    // Add any stored values as hidden fields (so they're included with FormData)
    keys.forEach(key => {
      const val = localStorage.getItem(key);
      if (val !== null) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = val;
        form.appendChild(input);
      }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // Prevent normal form submission!

      // Collect all form data
      const formData = new FormData(form);
      let person = {};
      keys.forEach(key => person[key] = formData.get(key) || "");
      person.agreePolicy = formData.get("agreePolicy") ? "on" : "";
      person.signature = formData.get("signature") || "";
      person.dateCompleted = formData.get("dateCompleted") || "";

      // Add this person to the array of registrants
      let registrants = JSON.parse(localStorage.getItem('registrants') || '[]');
      registrants.push(person);
      localStorage.setItem('registrants', JSON.stringify(registrants));

      // Clear person-specific info from localStorage for next registrant
      keys.concat(["agreePolicy", "signature", "dateCompleted"]).forEach(k => localStorage.removeItem(k));

      // Show custom modal for Yes/No choice
      document.getElementById('registerModal').style.display = 'flex';
    });

    // Attach modal button listeners ONCE (outside the submit handler)
    document.getElementById('yesBtn').onclick = function() {
      document.getElementById('registerModal').style.display = 'none';
      window.location.href = "intake.html";
    };

    document.getElementById('noBtn').onclick = function() {
      document.getElementById('registerModal').style.display = 'none';
      // Get registrants from localStorage
      let registrants = JSON.parse(localStorage.getItem('registrants') || '[]');
      fetch("https://script.google.com/macros/s/AKfycbzhRzgHnATpwgKkkdsQPw2Pn4DRHO0Snh1B4K0NTRo0GXM8_KC0eHt0wNqtQSk9iVMY/exec", {
        method: "POST",
        body: JSON.stringify({registrants}),
        headers: {"Content-Type": "application/json"}
      }).then(response => {
        if (response.ok) {
          alert("Registration complete!");
          localStorage.removeItem('registrants');
          form.reset();
          window.location.href = "thankyou.html";
        } else {
          alert("There was a problem submitting your registration.");
        }
      }).catch((err) => {
        console.log("Fetch error:", err);
        alert("There was a network error submitting your registration.");
      });
    };
  </script>
</body>
</html>